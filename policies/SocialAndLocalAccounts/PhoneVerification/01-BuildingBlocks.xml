<?xml version="1.0" encoding="utf-8" ?>
<TrustFrameworkPolicy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" PolicySchemaVersion="0.3.0.0" TenantId="{Settings:Tenant}" PolicyId="B2C_1A_PhoneVerify_BuildingBlocks" PublicPolicyUri="http://{Settings:Tenant}/B2C_1A_PhoneVerify_BuildingBlocks">

    <BasePolicy>
        <TenantId>{Settings:Tenant}</TenantId>
        <PolicyId>B2C_1A_MFA_Extensions</PolicyId>
    </BasePolicy>

    <BuildingBlocks>
        <ClaimsSchema>
            <ClaimType Id="extension_isPhoneSet">
                <DisplayName>The status of users phone number</DisplayName>
                <DataType>boolean</DataType>
                <AdminHelpText>This claim holds the status of the user's phone number</AdminHelpText>
            </ClaimType>
            <ClaimType Id="extension_mfaByPhoneOrTotp">
                <DisplayName>Please select your preferred MFA method</DisplayName>
                <DataType>string</DataType>
                <UserInputType>RadioSingleSelect</UserInputType>
                <Restriction>
                    <Enumeration Text="Phone" Value="phone" SelectByDefault="true" />
                    <Enumeration Text="Authenticator App " Value="authn" SelectByDefault="false" />
                </Restriction>
            </ClaimType>
            <ClaimType Id="isEditPhoneFlow">
                <DisplayName>The status of users phone number</DisplayName>
                <DataType>boolean</DataType>
                <AdminHelpText>This claim holds the status of the user's phone number</AdminHelpText>
            </ClaimType>


            <!-- Demo: The app code user provided-->
            <ClaimType Id="strongAuthenticationAppCode">
                <DisplayName>3. Enter the verification code</DisplayName>
                <DataType>string</DataType>
                <UserInputType>TextBox</UserInputType>
            </ClaimType>

            <!-- Demo: the QR code for app registrations-->
            <ClaimType Id="strongAuthenticationAppQRCodeBitmap">
                <DisplayName>Verified App QR Code Bitmap</DisplayName>
                <DataType>string</DataType>
                <UserInputType>Readonly</UserInputType>
            </ClaimType>

            <!-- Demo: Stores the user secret Key in Azure Active Directory user account
      This secret is generated by the REST API-->
            <ClaimType Id="extension_StrongAuthenticationAppSecretKey">
                <DisplayName>Verified App Secret Key</DisplayName>
                <DataType>string</DataType>
                <UserInputType>Readonly</UserInputType>
            </ClaimType>

            <!-- Demo: Stores the user last matched in Azure Active Directory user account.
      We use the attribute to prevent and verify the verification code has already been used.-->
            <ClaimType Id="extension_StrongAuthenticationAppTimeStepMatched">
                <DisplayName>Verified App Time Step Matched</DisplayName>
                <DataType>string</DataType>
            </ClaimType>

            <ClaimType Id="extension_isTotpSet">
                <DisplayName>Has the user verified by TOTP</DisplayName>
                <DataType>boolean</DataType>
            </ClaimType>

        </ClaimsSchema>

        <ClaimsTransformations>
            <ClaimsTransformation Id="CopyMfaPhoneToMobile" TransformationMethod="CopyClaim">
                <InputClaims>
                    <InputClaim ClaimTypeReferenceId="strongAuthenticationPhoneNumber" TransformationClaimType="inputClaim"/>
                </InputClaims>
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="mobile" TransformationClaimType="outputClaim"/>
                </OutputClaims>
            </ClaimsTransformation>

            <!-- <ClaimsTransformation Id="ClearMfaPhoneNumberTransform" TransformationMethod="NullClaim">
                <OutputClaims>
                    <OutputClaim ClaimTypeReferenceId="strongAuthenticationPhoneNumber" TransformationClaimType="claim_to_null" />
                </OutputClaims>
            </ClaimsTransformation> -->
        </ClaimsTransformations>

        <ContentDefinitions>
            <!-- Demo: The following content definition is used for registering a verification app.
      This HTML5 page, reads the QR code and presents image user can scan.
      Note: the paged run JavaScript. Use custom or shared domain to allow running client side code -->
            <ContentDefinition Id="api.selfasserted.appfactor.registration">
                <!--<LoadUri>~/tenant/default/selfasserted.cshtml</LoadUri>-->
                <LoadUri>{Settings:TotpUrl}/selfasserted-appfactor-registration.html</LoadUri>
                <RecoveryUri>~/common/default_page_error.html</RecoveryUri>
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.2.0</DataUri>
                <Metadata>
                    <Item Key="DisplayName">App Factor</Item>
                </Metadata>
            </ContentDefinition>
            <ContentDefinition Id="api.error">
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:globalexception:1.2.0</DataUri>
            </ContentDefinition>
            <ContentDefinition Id="api.idpselections">
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:providerselection:1.2.0</DataUri>
            </ContentDefinition>
            <ContentDefinition Id="api.idpselections.signup">
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:providerselection:1.2.0</DataUri>
            </ContentDefinition>
            <ContentDefinition Id="api.signuporsignin">
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:unifiedssp:1.2.0</DataUri>
            </ContentDefinition>
            <ContentDefinition Id="api.selfasserted">
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.2.0</DataUri>
            </ContentDefinition>
            <ContentDefinition Id="api.selfasserted.profileupdate">
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.2.0</DataUri>
            </ContentDefinition>
            <ContentDefinition Id="api.localaccountsignup">
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.2.0</DataUri>
            </ContentDefinition>
            <ContentDefinition Id="api.localaccountpasswordreset">
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.2.0</DataUri>
            </ContentDefinition>
            <ContentDefinition Id="api.phonefactor">
                <DataUri>urn:com:microsoft:aad:b2c:elements:contract:multifactor:1.2.0</DataUri>
            </ContentDefinition>
        </ContentDefinitions>

    </BuildingBlocks>


</TrustFrameworkPolicy>